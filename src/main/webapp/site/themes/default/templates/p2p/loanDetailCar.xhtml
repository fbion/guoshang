<ui:composition template="#{tplVars.currentThemePath}/templates/page.xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pm="http://primefaces.org/mobile"
                xmlns:archer="http://java.sun.com/jsf/archer"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:o="http://omnifaces.org/ui"
                xmlns:sec="http://www.springframework.org/security/facelets/tags"
                xmlns:c="http://java.sun.com/jsp/jstl/core">
    <f:metadata>
        <f:viewParam name="id" value="#{loanHome.id}"></f:viewParam>
        <f:viewParam name="investMoney" value="#{investHome.instance.money}"></f:viewParam>
    </f:metadata>
    <ui:define name="content">
        <ui:param name="loan" value="#{loanHome.instance}"></ui:param>
        <link type="text/css" rel="stylesheet" href="#{tplVars.themeStylePath}/chedai_details.css"/>
        <link type="text/css" rel="stylesheet" href="#{tplVars.themeStylePath}/ui.progress-bar.css"/>
        <script type="text/javascript" src="#{tplVars.themeJSPath}/chedai_details.js"></script>
        <script type="text/javascript" src="#{tplVars.themeJSPath}/progress.js"></script>
        <div class="content">
            <!-- 头部开始 -->
            <div class="bread_top">
                <a href="#{path}" style="margin-left:0px;">首页</a>
                <span>></span>
                <a href="#{path}/loan-list-all">我要理财</a>
                <span>></span>
                <a href="" style="color:#EB4647">#{loan.name}</a>
            </div>
            <!-- 头部结束 -->

            <!-- 产品介绍上部开始 -->
            <div class="product_up">
                <!-- 左 -->
                <div class="product_up_l">
                    <div class="product_name">
                        <span>#{loan.name}</span>
                    </div>
                    <div class="product_details">
                        <div class="product_details_l">
                            <img src="#{tplVars.themeImagePath}/version_two/houselogo.jpg" alt=""/>

                            <div></div>
                            <img src="#{tplVars.themeImagePath}/version_two/shouyigg.jpg" alt=""/>

                            <p>
                                收益高高，收益高高，
                            </p>

                            <p>收益高高，收益高高。</p>
                        </div>

                        <div class="product_details_r">
                            <ul class="d_r_ul1">
                                <li>
                                    <div class="d_r_title">
                                        <img src="#{tplVars.themeImagePath}/version_two/lilvico.jpg" alt="" width="20"
                                             height="20"/>

									<span class="d_r_titlez">
										年化利率
									</span>
                                    </div>
                                    <div class="d_r_num">
										<span><h:outputText
                                                value="#{loan.ratePercent}">
                                        </h:outputText></span>
                                        <span style="font-size:12px;">%</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="d_r_title">
                                        <img src="#{tplVars.themeImagePath}/version_two/qixianico.jpg" alt="" width="20"
                                             height="20"/>
									<span class="d_r_titlez">
										项目期限
									</span>
                                    </div>

                                    <div class="d_r_num">
										<span><h:outputText
                                                value="#{loan.deadline*loan.type.repayTimePeriod}">
                                        </h:outputText></span>
                                        <span style="font-size:12px;">#{dictUtil.getValue('repay_unit',loan.type.repayTimeUnit)}</span>
                                    </div>
                                </li>
                                <li>
                                    <div class="d_r_title">
                                        <img src="#{tplVars.themeImagePath}/version_two/jineico.jpg" alt="" width="20"
                                             height="20"/>

									<span class="d_r_titlez">
										融资金额
									</span>
                                    </div>
                                    <div class="d_r_num">
                                        <ui:fragment rendered="#{loan.loanMoney ge 100}">
                                            <span><h:outputText value="#{loan.loanMoney/10000}">
                                            </h:outputText></span>
                                            <span style="font-size:12px;">万</span>
                                        </ui:fragment>
                                        <ui:fragment rendered="#{loan.loanMoney lt 100}">
                                            <span><h:outputText value="#{loan.loanMoney}">
                                            </h:outputText></span>
                                            <span style="font-size:12px;">元</span>
                                        </ui:fragment>
                                    </div>
                                </li>
                            </ul>
                            <ul class="d_r_ul2">
                                <li>
                                    <div class="d_r_ul2_point"></div>
                                    <div class="point_r">
                                        <span>还款方式：</span>
                                        <span style="color:black;">#{dictUtil.getValue('repay_type',loan.type.repayType)}</span>
                                    </div>
                                    <div class="point_wen">
                                        <img src="#{tplVars.themeImagePath}/version_two/wenhao.jpg" alt=""/>

                                        <div class="wenhaosm">
                                            #{loan.type.name}
                                        </div>
                                    </div>
                                </li>

                                <li>
                                    <div class="d_r_ul2_point"></div>
                                    <div class="point_r">
                                        <span>项目特点：</span>
                                        <span style="color:black;">时间短，收益高</span>
                                    </div>
                                    <div class="point_wen">
                                        <img src="#{tplVars.themeImagePath}/version_two/wenhao.jpg" alt=""/>

                                        <div class="wenhaosm">
                                            问号问号问号问号问号问号
                                        </div>
                                    </div>
                                </li>


                                <li>
                                    <ui:fragment rendered="#{loanCalculator.calculateLoanCould(loan.id)=='未开始'}">
                                        <div id="muji" class="point_r" >
                                            <span>募集未开始</span>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{loanCalculator.calculateLoanCould(loan.id)=='RUNNING'}">

                                        <div id="shengyu" class="point_r">
                                            <span>剩余时间：</span>
                                            <span id="t_d" style="color:#EC4849;"></span>
                                            <span>天</span>
                                            <span id="t_h" style="color:#EC4849;"></span>
                                            <span>时</span>
                                            <span id="t_m" style="color:#EC4849;"></span>
                                            <span>分</span>
                                            <span id="t_s" style="color:#EC4849;"></span>
                                            <span>秒</span>
                                        </div>
                                        <!-- 隐藏域value存放数据库中剩余时间值，可能需要格式化时间，比如2017/05/1 10:00:00 -->
                                        <input id="surplus_time" type="hidden" value="#{loan.expectTime}"/>
                                        <script type="text/javascript">
								    function getRTime(){
								    	var surplus_time=$('#surplus_time').val();
								        var EndTime= new Date(surplus_time);
								        var NowTime = new Date();
								        var t =EndTime.getTime() - NowTime.getTime();
								        /*var d=Math.floor(t/1000/60/60/24);
								        t-=d*(1000*60*60*24);
								        var h=Math.floor(t/1000/60/60);
								        t-=h*60*60*1000;
								        var m=Math.floor(t/1000/60);
								        t-=m*60*1000;
								        var s=Math.floor(t/1000);*/

								        var d=Math.floor(t/1000/60/60/24);
								        var h=Math.floor(t/1000/60/60%24);
								        var m=Math.floor(t/1000/60%60);
								        var s=Math.floor(t/1000%60);

								        document.getElementById("t_d").innerHTML = d ;
								        document.getElementById("t_h").innerHTML = h ;
								        document.getElementById("t_m").innerHTML = m ;
								        document.getElementById("t_s").innerHTML = s ;
								    }
								    setInterval(getRTime,1000);

                                    </script>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{loanCalculator.calculateLoanCould(loan.id)=='已到期'}">
                                        <div id="muji" class="point_r">
                                            <span>募集已结束</span>
                                        </div>
                                    </ui:fragment>
                                </li>
                                <li>

                                    <div class="point_r">
                                        <span>项目进度：</span>
                                    </div>

                                    <div class="pro_bar_z">
                                        <div id="progress_bar" class="ui-progress-bar ui-container">
                                            <!-- ie小于等于9，添加ui-progress2样式,ie11，添加ui-progress3样式，ie1-0，添加ui-progress4样式 -->
                                            <div class="ui-progress ui-progress3 ui-progress4" style=""></div>

                                            <!--[if lte IE 9]>
                                            <script type="text/javascript">
													$('.ui-progress').addClass('ui-progress2');
                                            </script>
                                            <![endif]-->
                                        </div>
                                    </div>
                                    <!-- 隐藏域存放现在数据库中，进度百分数，比如65 -->
                                    <ui:param name="cr"
                                              value="#{loanCalculator.calculateRaiseCompletedRate(loan.id)}"></ui:param>
                                    <input type="hidden" name="" id="now_pro" value="#{cr}"/>
                                    <!-- span内放百分比，比如65 -->
								<span class="ui-label" style="">
								<span>#{cr}</span><span>%</span>
								</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- 左 -->
                <!-- 右 -->
                <div class="product_up_r">
                    <div class="pro_up_r_up">
                        <ul class="r_up_pro">
                            <li>
								<span style="color:#666666"><h:outputText value="#{loan.commitTime}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" locale="cn"
                                                       timeZone="GMT+8"></f:convertDateTime>
                                </h:outputText></span>
                                <span>项目发布</span>
                            </li>
                            <li>
								<span style="color:#666666"><h:outputText value="#{loan.giveMoneyTime}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" locale="cn"
                                                       timeZone="GMT+8"></f:convertDateTime>
                                </h:outputText></span>
                                <span>投资满额</span>
                            </li>
                            <li>
								<span style="color:#666666"><h:outputText value="#{loan.interestBeginTime}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" locale="cn"
                                                       timeZone="GMT+8"></f:convertDateTime>
                                </h:outputText></span>
                                <span>计息</span>
                            </li>
                            <li>
								<span style="color:#666666"><h:outputText value="#{loan.cancelTime}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" locale="cn"
                                                       timeZone="GMT+8"></f:convertDateTime>
                                </h:outputText></span>
                                <span>还款完成</span>
                            </li>
                        </ul>

                        <!-- 隐藏域存放数据库值，显示进度 -->
                        <ui:fragment rendered="#{loan.status==LoanStatus.RAISING}">
                           <input id="jinduvalue" type="hidden" name="jindu" value="1"/>
                        </ui:fragment>
                        <ui:fragment rendered="#{loan.status==LoanStatus.RECHECK}">
                            <input id="jinduvalue" type="hidden" name="jindu" value="2"/>
                        </ui:fragment>
                        <ui:fragment rendered="#{loan.status==LoanStatus.REPAYING}">
                            <input id="jinduvalue" type="hidden" name="jindu" value="3"/>
                        </ui:fragment>
                        <ui:fragment rendered="#{loan.status==LoanStatus.COMPLETE}">
                            <input id="jinduvalue" type="hidden" name="jindu" value="4"/>
                        </ui:fragment>


                        <!-- 隐藏域存放数据库值，显示进度 -->
                        <ul class="r_up_pro_line">
                            <li class="pro_line1"></li>
                            <li class="pro_line2" id="pro_l1"></li>
                            <li class="pro_line1"></li>
                            <li class="pro_line2" id="pro_l2"></li>
                            <li class="pro_line1"></li>
                            <li class="pro_line2" id="pro_l3"></li>
                            <li class="pro_line1"></li>
                        </ul>

                        <ul class="pro_line_down">
                            <li>
                                <span>投资起点：</span>
								<span style="color:#333333"><h:outputText value="#{loan.minInvestMoney}">
                                    <f:convertNumber type="number"/>
                                </h:outputText>
							元</span>
                            </li>
                            <li>
                                <span>剩余可投：</span>
								<span style="color:#333333"><h:outputText
                                        value="#{loanCalculator.calculateMoneyNeedRaised(loan.id)}">
                                    <f:convertNumber type="number"/>
                                </h:outputText>
							元</span>
                            </li>
                            <li>
                                <span>递增金额：</span>
								<span style="color:#333333"><h:outputText value="#{loan.cardinalNumber}">
                                    <f:convertNumber type="number"/>
                                </h:outputText>
							元</span>
                            </li>
                            <li>
                                <ui:fragment rendered="#{empty loginUserInfo.loginUserId}">
						         <span style="color:#EA4748;">
							         <a href="#{request.contextPath}/memberLogin"
                                        style="text-decoration:none;color:#EA4748">登录后查看</a>
							     </span>
                                </ui:fragment>
                                <ui:fragment rendered="#{not empty loginUserInfo.loginUserId}">
                                    <span>账户余额：</span>
								       <span style="color:#333333;"><h:outputLabel
                                               value="#{userBillHome.getBalanceByUserId(loginUserInfo.loginUserId)}">
                                           <f:convertNumber/>
                                       </h:outputLabel>元</span>
                                </ui:fragment>
                            </li>
                        </ul>
                    </div>
                    <div class="pro_up_r_down">
                        <h:form>
                            <div class="num_change">
                                <a href="javascript:;" class="num" id="jian">
                                    <img src="#{tplVars.themeImagePath}/version_two/jian.jpg" alt=""/>
                                </a>
                                <h:inputText label="投资金额" value="#{investHome.instance.money}"
                                             styleClass="txtinput" required="true"
                                             requiredMessage="投资金额不能为空！">
                                    <f:ajax event="blur" render="@this"></f:ajax>
                                    <o:validator validatorId="javax.faces.DoubleRange"
                                                 minimum="#{loan.minInvestMoney}"
                                                 maximum="#{loanCalculator.calculateMoneyMaxInvested(loan.id)}"></o:validator>
                                    <o:validator
                                            validatorId="com.esoft.core.validator.NumberValidator"
                                            cardinalNumber="#{loan.cardinalNumber}"></o:validator>
                                </h:inputText>
                                <a href="javascript:;" class="num" id="jia">
                                    <img src="#{tplVars.themeImagePath}/version_two/jia.jpg" alt=""/>
                                </a>
                            </div>

                            <div class="expect">
                                <span>预期收益</span>
                                <span>19.6</span>
                                <span>元</span>
                            </div>
                            <ui:fragment rendered="#{loan.status ==LoanStatus.RAISING}">
                                <p>
                                    <ui:fragment rendered="#{empty loginUserInfo.loginUserId}">
                                        <h:link outcome="pretty:memberLogin" styleClass="investmentbtn">
                                            <f:param name="spring-security-redirect"
                                                     value="/loanDetailCar/#{loan.id}"/>
                                            <h:outputText value="立即投资"></h:outputText>
                                        </h:link>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{not empty loginUserInfo.loginUserId}">
                                        <sec:ifNotGranted roles="INVESTOR">
                                            <a class="investmentbtn" href="javascript:void(0)"
                                               onclick="getInvestorPer();">立即投资</a>
                                        </sec:ifNotGranted>

                                        <sec:ifAllGranted roles="INVESTOR">
                                            <h:commandLink styleClass="investmentbtn"
                                                           action="#{investHome.save}" value="立即投资"
                                                           onclick="return confirm('您确定要投资吗？');">
                                                <f:setPropertyActionListener
                                                        target="#{investHome.instance.loan}"
                                                        value="#{loan}"></f:setPropertyActionListener>
                                            </h:commandLink>
                                        </sec:ifAllGranted>
                                    </ui:fragment>

                                </p>
                            </ui:fragment>
                        </h:form>


                    </div>
                </div>
                <!-- 右 -->
            </div>
            <!-- 产品介绍上部结束 -->

            <!-- 产品介绍下部开始 -->
            <div class="product_down">
                <ul class="intro_tab">
                    <li class="intro_tab1">
                        <span>项目简介</span>
                        <span class="intro_tab_line1" style="display:block;"></span>
                        <span class="intro_tab_line2" style="display:block;"></span>
                    </li>
                    <li class="intro_tab2">
                        <span>抵押物信息</span>
                        <span class="intro_tab_line1"></span>
                        <span class="intro_tab_line2"></span>
                    </li>
                    <li class="intro_tab3" style="border-right:1px solid #DCDCDC;">
                        <span>投资记录</span>
                        <span class="intro_tab_line1"></span>
                        <span class="intro_tab_line2"></span>
                    </li>
                </ul>

                <div class="intro_tab_down">
                    <div class="intro_tab_down_c">
                        <ul class="i_t_d_c1">
                            <li>
                                <span class="i_t_d_cspan">品牌型号：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">奥迪A4L</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">品牌型号：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">奥迪A4L</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">品牌型号：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">奥迪A4L</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">品牌型号：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">奥迪A4L</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">品牌型号：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">奥迪A4L</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">品牌型号：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">奥迪A4L</span>
                            </li>
                        </ul>
                        <ul style="display:none;" class="i_t_d_c2">
                            <li>
                                <span class="i_t_d_cspan">品牌类型：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">#{loan.infoOne}</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">车牌号码：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">#{loan.infoTwo}</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">里程数：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">#{loan.infoThree}</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">评估价格：</span>
                                <span class="i_t_d_cspan" style="color:#333333;width:370px;">#{loan.infoFour}</span>
                            </li>
                            <li>
                                <span class="i_t_d_cspan">购买时间：</span>
								<span class="i_t_d_cspan" style="color:#333333;width:370px;"><h:outputText
                                        value="#{loan.infoTime}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" locale="cn"
                                                       timeZone="GMT+8"></f:convertDateTime>
                                </h:outputText></span>
                            </li>
                        </ul>
                        <div style="display:none;" class="i_t_d_c3">
                            <h:form id="investsForm" style="margin-top: 20px;">
                                <table cellpadding="0" cellspacing="0">
                                    <tr class="p2c_tab_tr">
                                        <td width="25%" class="c3_td1">投资人</td>
                                        <td width="25%" class="c3_td1">投资金额</td>
                                        <td width="25%" class="c3_td1">投资时间</td>
                                        <td width="25%" class="c3_td1">状态</td>
                                    </tr>
                                    <f:event type="preRenderComponent"
                                             listener="#{investList.example.loan.setId(loan.id)}"></f:event>
                                    <f:event type="preRenderComponent"
                                             listener="#{investList.addOrder('invest.time','desc')}"></f:event>
                                    <f:event type="preRenderComponent"
                                             listener="#{investList.setPageSize(10)}"></f:event>
                                    <ui:repeat var="invest" value="#{investList.lazyModelData}">
                                        <tr>
                                            <td width="25%" class="c3_td2">#{invest.user.username.substring(0,3)}***
                                            </td>
                                            <td width="25%" class="c3_td2">
                                                <h:outputText
                                                        value="#{invest.investMoney}">
                                                    <f:convertNumber maxFractionDigits="2"/>
                                                </h:outputText>
                                                元
                                            </td>
                                            <td width="25%" class="c3_td2">
                                                <h:outputText value="#{invest.time}">
                                                    <f:convertDateTime pattern="yyyy-MM-dd HH:mm:ss" locale="cn"
                                                                       timeZone="GMT+8"></f:convertDateTime>
                                                </h:outputText>
                                            </td>
                                            <td width="25%" class="c3_td2">#{dictUtil.getValue('invest_status',
									invest.status)}
                                            </td>
                                        </tr>
                                    </ui:repeat>
                                </table>
                                <div class="pagebar">
                                    <ui:include
                                            src="#{tplVars.componentsPath}/loan-list_invests-paging_include.xhtml"></ui:include>
                                </div>
                                <div class="clear"></div>
                            </h:form>
                        </div>
                    </div>
                    <div class="intro_tab_down_lunbo">
                        <!-- 图片部分 -->
                        <ui:repeat var="infoPic" varStatus="status" value="#{loan.guaranteeInfoPics}">
                            <ui:fragment rendered="#{status.index==0}">
                                <img class="lunbo_big_img" style="display:block;"
                                     src="#{request.contextPath}#{infoPic.picture}" alt=""/>
                            </ui:fragment>

                            <ui:fragment rendered="#{status.index!=0}">
                                <img class="lunbo_big_img" src="#{request.contextPath}#{infoPic.picture}" alt=""/>
                            </ui:fragment>

                        </ui:repeat>
                        <!-- 列表区域 -->
                        <div class="lunbok">
                            <ul>
                                <ui:repeat var="infoPic" value="#{loan.guaranteeInfoPics}" varStatus="status">

                                    <ui:fragment rendered="#{status.index==0}">
                                        <li style="border:3px solid #666666;">
                                            <img src="#{request.contextPath}#{infoPic.picture}" alt=""/>
                                        </li>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{status.index!=0}">
                                        <li>
                                            <img src="#{request.contextPath}#{infoPic.picture}" alt=""/>
                                        </li>
                                    </ui:fragment>
                                </ui:repeat>
                            </ul>
                        </div>
                        <!-- 左右两侧 -->
                        <a href="javascript:;" class="left" style="left:46px;">
                            <div class="cover"></div>
                            <div class="cont">&lt;</div>
                        </a>
                        <a href="javascript:;" class="right" style="right:46px;">
                            <div class="cover"></div>
                            <div class="cont">&gt;</div>
                        </a>
                    </div>
                </div>
            </div>
            <!-- 产品介绍下部结束 -->
        </div>


        <script>
			  //如果登录用户没有投资权限，则提示，并跳转页面。
		    function getInvestorPer() {
				$.dialog
						.confirm(
								'您尚未进行实名认证无法投资，是否要实名认证？',
								function() {
									window.location.href = "#{request.contextPath}/user/get_investor_permission";
									$.dialog.tips('正在为您跳转到页面');
								});
				return false;
			}

        </script>

    </ui:define>
</ui:composition>
